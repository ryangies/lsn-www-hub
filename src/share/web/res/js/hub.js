// Livesite (c) Livesite Networks, LLC 2006-2013.

ECMAScript.Extend('lsn.hubb.command',function(ecma){function _dataType(name,node){var type=null;if(ecma.util.isa(node,ecma.data.Container)){type=node instanceof ecma.hubb.HashNode?'data-hash':node instanceof ecma.hubb.ArrayNode?'data-array':undefined;}else{type='data-scalar';var ext=ecma.data.addr_ext(name);if(ext)type+='-'+ext;}
ecma.lang.assert(type!=null);return type;}
var CAction=ecma.action.ActionDispatcher;var CParameters=ecma.impl.Parameters;var CRequest=ecma.lsn.Request;this.Base=function CBase(verb){CAction.apply(this);CParameters.apply(this);CRequest.apply(this,['/api/hub/'+verb,{method:'POST'}]);this.verb=verb;this.cbList=[];this.argspec=[];this.result=undefined;this.setHeader('X-Auth-Token',ecma.lsn.auth.getAuthToken());};var Base=this.Base.prototype=ecma.lang.createPrototype(CAction,CParameters,CRequest);Base.setArguments=function(){var params=ecma.util.associateArrays(arguments,this.argspec);return this.overlayParameters(params);};Base.setHeaders=function(headers){for(name in headers){this.setHeader(name,headers[name]);}
return this.headers;};Base.submit=function(cb){this.result=undefined;if(cb)this.cbList.push(cb);var params=this.getParameters();return CRequest.prototype.submit.call(this,params);};Base.getXFR=function(encoding){return new ecma.hubb.XFR(encoding);};Base.callback=function(){try{var args=ecma.util.args(arguments);ecma.util.step(this.cbList,this.invokeCallback,this,args);}catch(ex){}finally{this.cbList=[];}};Base.invokeCallback=function(cb){var args=ecma.util.args(arguments);args.shift();ecma.lang.callback(cb,null,args);};Base.onSuccess=function(){this.process(this.responseHash);};Base.validate=function(rh){try{ecma.lang.assert(rh);var error=rh.getObject('/head/error');if(error){if(error.type=='Error::DoesNotExist'||error.type=='Error::NotFound'){var addr=rh.getString('/head/meta/addr');if(addr)this.executeAction('remove',addr);}
throw new Error('[Server Error]'+error.message);}}catch(ex){return false;}
return true;};Base.onComplete=function(){this.dispatchAction('complete',this);this.callback(this.result);};Base.process=function(rh){var responses;var type=rh.getString('/head/struct');if(type=='branch'){if(!this.validate(rh)){return;}
responses=rh.get('body').values();}else{responses=[rh];}
for(var i=0,rh2;rh2=responses[i];i++){if(this.validate(rh2)){this.fixup(rh2);}}};Base.fixup=function(rh){var meta=rh.get('/head/meta').toObject();var struct=rh.get('/body');ecma.lang.assert(struct);struct.attributes=meta;if(struct.isDirectory()){struct.iterate(function(k,v){var type=v.getString('type');if(!type)throw new Error('Malformed response hash');ecma.lang.assert(type&&type.match(/^(directory|file)\b/));var stub=new ecma.hubb.HashNode();stub.attributes=v.toObject();stub.setAttribute('mtime',0);stub.setAttribute('mtime2',v.get('mtime'));struct.setValue(k,stub);});}else if(struct.isDataContainer()){var baseAddr=struct.getAddress();struct.walk(function(name,item,depth,addr){item.attributes={'addr':ecma.data.addr_join(baseAddr,addr),'type':_dataType(name,item)};});}
this.result=struct;this.executeAction('fixup',this.result);};Base.getResult=function(){return this.result;};});ECMAScript.Extend('lsn.hubb.command',function(ecma){var CBase=ecma.lsn.hubb.command.Base;this.Fetch=function(){CBase.call(this,'fetch');this.argspec=['target'];};var Fetch=this.Fetch.prototype=ecma.lang.createPrototype(CBase);});ECMAScript.Extend('lsn.hubb.command',function(ecma){var CBase=ecma.lsn.hubb.command.Base;this.Store=function(){CBase.call(this,'store');this.argspec=['target','value','mtime','force'];};var Store=this.Store.prototype=ecma.lang.createPrototype(CBase);});ECMAScript.Extend('lsn.hubb.command',function(ecma){var CBase=ecma.lsn.hubb.command.Base;this.Update=function(){CBase.call(this,'update');this.argspec=['target','values','mtime','force'];};var Update=this.Update.prototype=ecma.lang.createPrototype(CBase);});ECMAScript.Extend('lsn.hubb.command',function(ecma){var CBase=ecma.lsn.hubb.command.Base;this.Create=function(){CBase.call(this,'create');this.argspec=['target','name','type','value'];};var Create=this.Create.prototype=ecma.lang.createPrototype(CBase);});ECMAScript.Extend('lsn.hubb.command',function(ecma){var CBase=ecma.lsn.hubb.command.Base;this.Insert=function(){CBase.call(this,'insert');this.argspec=['target','index','src'];};var Insert=this.Insert.prototype=ecma.lang.createPrototype(CBase);});ECMAScript.Extend('lsn.hubb.command',function(ecma){var CBase=ecma.lsn.hubb.command.Base;this.Remove=function(){CBase.call(this,'remove');this.argspec=['target'];};var Remove=this.Remove.prototype=ecma.lang.createPrototype(CBase);Remove.fixup=function(rh){var meta=rh.get('/head/meta').toObject();this.executeAction('remove',meta.addr,meta);};});ECMAScript.Extend('lsn.hubb.command',function(ecma){var CBase=ecma.lsn.hubb.command.Base;this.Rename=function(){CBase.call(this,'rename');this.argspec=['target','name'];};var Rename=this.Rename.prototype=ecma.lang.createPrototype(CBase);Rename.fixup=function(rh){var meta=rh.get('/head/meta').toObject();this.executeAction('rename',meta);};});ECMAScript.Extend('lsn.hubb.command',function(ecma){var CBase=ecma.lsn.hubb.command.Base;this.Copy=function(){CBase.call(this,'copy');this.argspec=['target','dest'];};var Copy=this.Copy.prototype=ecma.lang.createPrototype(CBase);});ECMAScript.Extend('lsn.hubb.command',function(ecma){var CBase=ecma.lsn.hubb.command.Base;this.Move=function(){CBase.call(this,'move');this.argspec=['target','dest'];};var Move=this.Move.prototype=ecma.lang.createPrototype(CBase);Move.process=function(rh){var srcAddr=rh.getString('/head/source');this.executeAction('remove',srcAddr);CBase.prototype.process.apply(this,arguments);};});ECMAScript.Extend('lsn.hubb.command',function(ecma){var CBase=ecma.lsn.hubb.command.Base;this.Reorder=function(){CBase.call(this,'reorder');this.argspec=['target','value'];};var Reorder=this.Reorder.prototype=ecma.lang.createPrototype(CBase);Reorder.fixup=function(rh){var meta=rh.getObject('/head/meta');var keys=rh.getObject('/body');this.executeAction('reorder',meta.addr,keys,meta);};});ECMAScript.Extend('lsn.hubb.command',function(ecma){var CBase=ecma.lsn.hubb.command.Base;this.Download=function(){CBase.call(this,'download');this.argspec=['target','name','uri','replace'];};var Download=this.Download.prototype=ecma.lang.createPrototype(CBase);Download.fixup=function(){};});ECMAScript.Extend('lsn.hubb.command',function(ecma){var CBase=ecma.lsn.hubb.command.Base;this.Progress=function(){CBase.call(this,'progress');this.argspec=['target','id','type','interval'];this.setParameter('interval',2000);};var Progress=this.Progress.prototype=ecma.lang.createPrototype(CBase);Progress.start=function(){this.checkStatus();};Progress.end=function(){this.req=null;this.executeAction('onComplete',this.result);};Progress.checkStatus=function(){ecma.dom.setTimeout(this.submit,this.getParameter('interval'),this);};Progress.submit=function(){if(this.req){this.req.resubmit();}else{var verb=this.getParameter('type')+'_progress';this.req=new ecma.http.JSONRequest('/api/hub/'+verb,{'method':'GET'});this.req.addEventListener('onSuccess',this.onSuccess,this);this.req.addEventListener('onNotSuccess',this.end,this);this.req.setHeader('X-Progress-ID',this.getParameter('id'));this.req.submit();}};Progress.onSuccess=function(r){var result=r.responseJSON;var percent=0;var rec=0;var sz=0;if(!result)return this.end();if(result.body)result=result.body;this.result=result;switch(result.state){case'starting':sz=rec=0;break;case'uploading':sz=result.size;rec=result.received;break;case'done':sz=rec=1;break;case'error':var errorCode=result.status;default:return this.end();}
var percent=Math.round((rec/sz)*100);if(isNaN(percent))return this.checkStatus();var msg=percent+'% ('+rec+' / '+sz+')';var stats={'addr':this.getParameter('target'),'size':sz,'transfered':rec,'percent':percent,'display':{'size':sz,'transfered':rec,'message':msg}};this.executeAction('status',stats);if(result.state=='done')return this.end();this.checkStatus();};});ECMAScript.Extend('lsn.hubb.command',function(ecma){var CBase=ecma.lsn.hubb.command.Base;this.Batch=function(){CBase.call(this,'batch');this.commands=[];};var Batch=this.Batch.prototype=ecma.lang.createPrototype(CBase);Batch.addCommand=function(){var args=ecma.util.args(arguments);var verb=args.shift();var cmd=ecma.lsn.hubb.command.createInstance(verb);cmd.setArguments.apply(cmd,args);cmd.setParameter('verb',verb);this.commands.push(cmd);return cmd;};Batch.getParameters=function(){var result=[];for(var i=0,cmd;cmd=this.commands[i];i++){result.push(cmd.getParameters());}
return result;};Batch.process=function(rh){var result=rh.get('body').values();ecma.lang.assert(result.length==this.commands.length);for(var i=0;i<result.length;i++){this.commands[i].process(result[i]);}
this.result=this.commands;};});ECMAScript.Extend('lsn.hubb.command',function(ecma){var _verbToClass={'fetch':ecma.lsn.hubb.command.Fetch,'store':ecma.lsn.hubb.command.Store,'update':ecma.lsn.hubb.command.Update,'create':ecma.lsn.hubb.command.Create,'insert':ecma.lsn.hubb.command.Insert,'remove':ecma.lsn.hubb.command.Remove,'rename':ecma.lsn.hubb.command.Rename,'copy':ecma.lsn.hubb.command.Copy,'move':ecma.lsn.hubb.command.Move,'download':ecma.lsn.hubb.command.Download,'progress':ecma.lsn.hubb.command.Progress,'reorder':ecma.lsn.hubb.command.Reorder,'batch':ecma.lsn.hubb.command.Batch};this.createInstance=function(verb){var ctor=_verbToClass[verb];if(!ctor)throw new Error('Missing implementation');return ecma.lang.createObject(ctor);};});ECMAScript.Extend('hubb',function(ecma){var _icons={};_icons['application-wireframe.png']='/res/icons/16x16/nodes/application-wireframe.png';_icons['applications-internet.png']='/res/icons/16x16/nodes/applications-internet.png';_icons['bgleft.png']='/res/icons/16x16/nodes/bgleft.png';_icons['canexp.png']='/res/icons/16x16/nodes/canexp.png';_icons['data-array.png']='/res/icons/16x16/nodes/data-array.png';_icons['data-hash.png']='/res/icons/16x16/nodes/data-hash.png';_icons['data-scalar.png']='/res/icons/16x16/nodes/data-scalar.png';_icons['directories.png']='/res/icons/16x16/nodes/directories.png';_icons['directory-mount.png']='/res/icons/16x16/nodes/directory-mount.png';_icons['directory.png']='/res/icons/16x16/nodes/directory.png';_icons['file-bmp.png']='/res/icons/16x16/nodes/file-bmp.png';_icons['file-csv.png']='/res/icons/16x16/nodes/file-csv.png';_icons['file-data-array.png']='/res/icons/16x16/nodes/file-data-array.png';_icons['file-data-hash.png']='/res/icons/16x16/nodes/file-data-hash.png';_icons['file-data.png']='/res/icons/16x16/nodes/file-data.png';_icons['file-doc.png']='/res/icons/16x16/nodes/file-doc.png';_icons['file-flv.png']='/res/icons/16x16/nodes/file-flv.png';_icons['file-gif.png']='/res/icons/16x16/nodes/file-gif.png';_icons['file-jar.png']='/res/icons/16x16/nodes/file-jar.png';_icons['file-jpeg.png']='/res/icons/16x16/nodes/file-jpeg.png';_icons['file-jpg.png']='/res/icons/16x16/nodes/file-jpg.png';_icons['file-mp3.png']='/res/icons/16x16/nodes/file-mp3.png';_icons['file-multipart-html.png']='/res/icons/16x16/nodes/file-multipart-html.png';_icons['file-multipart.png']='/res/icons/16x16/nodes/file-multipart.png';_icons['file-pdf.png']='/res/icons/16x16/nodes/file-pdf.png';_icons['file-pm.png']='/res/icons/16x16/nodes/file-pm.png';_icons['file-png.png']='/res/icons/16x16/nodes/file-png.png';_icons['file-swf.png']='/res/icons/16x16/nodes/file-swf.png';_icons['file-text-cgi.png']='/res/icons/16x16/nodes/file-text-cgi.png';_icons['file-text-css.png']='/res/icons/16x16/nodes/file-text-css.png';_icons['file-text-ht.png']='/res/icons/16x16/nodes/file-text-ht.png';_icons['file-text-html.png']='/res/icons/16x16/nodes/file-text-html.png';_icons['file-text-js.png']='/res/icons/16x16/nodes/file-text-js.png';_icons['file-text-pl.png']='/res/icons/16x16/nodes/file-text-pl.png';_icons['file-text-pm.png']='/res/icons/16x16/nodes/file-text-pm.png';_icons['file-text-txt.png']='/res/icons/16x16/nodes/file-text-txt.png';_icons['file-text.png']='/res/icons/16x16/nodes/file-text.png';_icons['file-zip.png']='/res/icons/16x16/nodes/file-zip.png';_icons['folders.png']='/res/icons/16x16/nodes/folders.png';_icons['isempty.png']='/res/icons/16x16/nodes/isempty.png';_icons['isexp.png']='/res/icons/16x16/nodes/isexp.png';_icons['mpe-bg.png']='/res/icons/16x16/nodes/mpe-bg.png';_icons['mpe-data-array.png']='/res/icons/16x16/nodes/mpe-data-array.png';_icons['mpe-data-hash.png']='/res/icons/16x16/nodes/mpe-data-hash.png';_icons['mpe-data-scalar.png']='/res/icons/16x16/nodes/mpe-data-scalar.png';_icons['mpe-end.png']='/res/icons/16x16/nodes/mpe-end.png';_icons['noexp.png']='/res/icons/16x16/nodes/noexp.png';_icons['unknown.png']='/res/icons/16x16/nodes/unknown.png';_icons['user-home.png']='/res/icons/16x16/nodes/user-home.png';_icons['loading.png']='/res/icons/16x16/nodes/loading.gif';this.getIconByType=function(type){if(!type)throw new Error('Missing type for icon');var parts=type.split('-');var icon=undefined;while(!icon&&parts.length>0){var name=parts.join('-')+'.png';icon=_icons[name];if(!icon&&parts.length==3&&parts[1]=='multipart'){name=parts[0]+'-'+parts[2]+'.png';icon=_icons[name];}
parts.pop();}
return icon||_icons['unknown.png'];};this.getIconByName=function(name){return _icons[name];};});ECMAScript.Extend('hubb',function(ecma){var CActionDispatcher=ecma.action.ActionDispatcher;this.Node=function(){CActionDispatcher.apply(this);this.iid=ecma.util.rand8();this.attributes={};};var Node=this.Node.prototype=ecma.lang.createPrototype(CActionDispatcher);Node.getInstanceId=function(){return this.iid;};Node.getDataNode=function(){return this;};Node.executeAction=function(){var invoker=CActionDispatcher.prototype.executeAction;this.invokeAction(invoker,false,arguments);};Node.dispatchAction=function(){var invoker=CActionDispatcher.prototype.dispatchAction;this.invokeAction(invoker,false,arguments);};Node.invokeAction=function(invoker,bBubble,args){if(bBubble){var node=this;while(node&&node.parentNode){invoker.apply(node,args);node=node.parentNode;}
var root=node===this?null:node;if(root&&root.db)invoker.apply(root.db,args);}else{invoker.apply(this,args);var root=this.getRoot();if(root&&root.db){invoker.apply(root.db,args);}}};Node.createStubNode=function(key){ecma.lang.assert(!this.getValue(key));var stub=new ecma.hubb.ScalarNode();stub.setAddress(this.getAddress()+'/'+key);stub.setAttribute('type','unknown');stub.setAttribute('mtime','0');this.replaceValue(key,stub);return stub;};Node.toString=function(){return'';};Node.getTimestamp=function(){var storage=this.getStorage();return storage.getAttribute('mtime');};Node.hasFetched=function(){return this.isData()?true:this.getTimestamp()?true:false;};Node.getModifiedDate=function(){var storage=this.getStorage();if(!storage)return null;var mtime=storage.getAttribute('mtime');if(!mtime)return null;return new Date(1000*mtime);};Node.getDate=function(){var storage=this.getStorage();if(!storage)return null;var mtime=storage.getAttribute('mtime')||storage.getAttribute('mtime2');if(!mtime)return null;return new Date(1000*mtime);};Node.getStorage=function(){if(this.storage)return this.storage;var node=this;var storage=null;while(node&&!storage){var type=node.getAttribute('type');if(type&&type.match(/^(directory|file-)/))storage=node;node=node.parentNode;}
return this.storage=storage;};Node.getContent=function(){return this.getAttribute('content');};Node.getAddress=function(){return this.getAttribute('addr');};Node.setAddress=function(addr){return this.setAttribute('addr',addr);};Node.setParentAddress=function(paddr){var key=this.getKey();var addr=ecma.data.addr_join(paddr,key);this.setAddress(addr);};Node.getType=function(){return this.getAttribute('type')||'';};Node.getIcon=function(){var iconPath=this.getAttribute('icon');if(!iconPath){var type=this.getType();ecma.lang.assert(type);iconPath=ecma.hubb.getIconByType(type);this.setAttribute('icon',iconPath);}
return iconPath;};Node.getFilesize=function(){var bytes=this.isFile()?this.getAttribute('size'):undefined;if(ecma.util.defined(bytes)){bytes=ecma.units.bytesize(bytes);}else{bytes='';}
return bytes;};Node.isDirectory=function(){return this.getType().match(/^directory/)?true:false;};Node.isFile=function(){return this.getType().match(/^file-/)?true:false;};Node.isData=function(){return this.getType().match(/^data-/)?true:false;};Node.isDataArray=function(){return this.getType().match(/^data-array/)?true:false;};Node.isDataHash=function(){return this.getType().match(/^data-hash/)?true:false;};Node.isDataContainer=function(){return this.getType().match(/^(data-(hash|array)|file-((binary-)?multipart|data))/)?true:false;};Node.canExpand=function(){var type=this.getType();if(!type)return false;return type=='directory'||type.match(/^file-(data|multipart)/)||type.match(/^data-(array|hash)/)?true:false;};Node.getKey=function(){return ecma.util.defined(this.attributes['key'])?this.attributes['key']:this.attributes['key']=ecma.data.addr_name(this.getAddress());};Node.setKey=function(key){var parentNode=this.getParentNode();var paddr=parentNode?parentNode.getAddress():ecma.data.addr_parent(this.getAddress());var addr=ecma.data.addr_join(paddr,key);this.setAttribute('key',key);this.setAddress(addr);this.executeAction({'name':'update','updated':{'key':key,'addr':addr}},this);};Node.getIndex=function(){if(!this.parentNode)return null;return this.parentNode.indexOfValue(this);};Node.getRoot=function(){var node=this;while(node&&node.parentNode){node=node.parentNode;}
return node;};Node.getDataBridge=function(){return this.getRoot().db;};Node.fetch=function(cb){this.getRoot().db.fetch(this.getAddress(),cb);};Node.reload=function(cb){this.getRoot().db.getAndFetch(this.getAddress(),cb);};Node.load=function(cb,bRevalidate){if(bRevalidate){ecma.console.trace('[DEPRECATED] Use .reload (not load+validate)');this.getRoot().db.getAndFetch(this.getAddress(),cb);}else{this.getRoot().db.get(this.getAddress(),cb);}};Node.setParentNode=function(node){return this.parentNode=node;};Node.getParentNode=function(){return this.parentNode;};Node.getPreviousSibling=function(){var parentNode=this.getParentNode();if(!parentNode)return null;var children=parentNode.values();for(var i=0;i<children.length;i++){if(children[i]===this){return i>0?children[i-1]:null;}}
return null;};Node.setAttribute=function(name,value){return this.attributes[name]=value;};Node.getAttribute=function(name){return this.attributes[name];};Node.removeAttribute=function(name){delete this.attributes[name];};function _takeIndex(value,parentNode){var prevKey=value.getAttribute('prev');var prevIndex=prevKey?parentNode.indexOfKey(prevKey):null;var index=ecma.util.defined(prevIndex)?prevIndex+1:0;delete value.attributes['prev'];return index;}
Node.merge=function(value){var isUpdated=false;var updated={};for(var k in this.attributes){if(!(k in value.attributes)){delete this.attributes[k];}}
for(var k in value.attributes){var v=value.attributes[k];if(this.attributes[k]!=v){updated[k]=this.attributes[k]=v;isUpdated=true;}}
if(this.attributes['prev']&&this.parentNode&&!this.parentNode.isDataArray()){var index=_takeIndex(this,this.parentNode);if(index!=this.getIndex()){var key=ecma.data.addr_name(this.getAddress());this.parentNode.setValue(key,this,index);updated['index']=index;isUpdated=true;}}
if(isUpdated){this.executeAction({'name':'update','updated':updated},this);}
return this;};Node.mergeRename=function(meta){ecma.lang.assert(meta.old_name==this.getKey());this.setKey(meta.new_name);var parentNode=this.getParentNode();if(parentNode){var currentIndex=this.getIndex();var newIndex=currentIndex;if(meta.prev){var prevIndex=parentNode.indexOfKey(meta.prev);if(ecma.util.defined(prevIndex)){newIndex=prevIndex+1;}}
var result=parentNode.renameValue(meta.old_name,meta.new_name,newIndex);js.lang.assert(result===this);if(newIndex!=currentIndex){this.executeAction({'name':'update','updated':{'index':newIndex}},this);parentNode.executeAction({'name':'update','updated':{'order':true}},this);}}
if(this.isDataContainer()){var baseAddr=this.getAddress();this.walk(function(name,node,depth,addr){node.setAttribute('addr',ecma.data.addr_join(baseAddr,addr));});}};Node.createValue=function(key,value){ecma.lang.assert(value);var index=_takeIndex(value,this);var result=this.setValue(key,value,index);this.executeAction('create',value,'new create: '+key);return result;};Node.replaceValue=function(key,value){var currentValue=this.getValue(key);if(currentValue){return currentValue.merge(value);}else{return this.createValue(key,value);}};});ECMAScript.Extend('hubb',function(ecma){var CArray=ecma.data.Array;var CNode=ecma.hubb.Node;this.ArrayNode=function(){CArray.apply(this,arguments);CNode.apply(this,arguments);};var proto=ecma.lang.createPrototype(CArray,CNode);this.ArrayNode.prototype=proto;proto.setAddress=function(addr){CNode.prototype.setAddress.call(this,addr);this.iterate(function(key,value){value.setParentAddress(addr);});};proto.renameValue=function(oldKey,newKey,index){throw new Error('Array nodes cannot be renamed');};proto.setValue=function(key,value){var result=CArray.prototype.setValue.call(this,key,value);if(ecma.util.isa(value,ecma.hubb.Node)){value.setParentNode(this);}
return result;};proto.sortByKey=function(keys){if(keys.length!==this.length)throw new Error('Length mis-match');var hasChanged=false;var data=[];for(var i in keys){var key=keys[i];var item=this.getValue(key);if(item.getKey()!=i){item.setKey(i);hasChanged=true;}
data.push(item);}
if(hasChanged){this.data=data;this.executeAction({'name':'update','updated':{'order':true}},this);}};proto.removeValue=function(key){var result=CArray.prototype.removeValue.call(this,key);if(result){for(var i=key;i<this.data.length;i++){var item=this.data[i];item.setKey(i);}
result.executeAction('remove',result);return result;}};proto.merge=function(value){while(this.length>value.length){this.removeValue(this.length-1);}
value.iterate(function(k,v){var myValue=this.getValue(k);try{myValue.merge(v);}catch(ex){this.setValue(k,v);var action=myValue?'replace':'create';this.executeAction(action,v,'key='+k);}},this);return CNode.prototype.merge.apply(this,arguments);};});ECMAScript.Extend('hubb',function(ecma){var CHashList=ecma.data.HashList;var CNode=ecma.hubb.Node;this.HashNode=function(){CHashList.apply(this,arguments);CNode.apply(this,arguments);};var proto=ecma.lang.createPrototype(CHashList,CNode);this.HashNode.prototype=proto;proto.setAddress=function(addr){CNode.prototype.setAddress.call(this,addr);this.iterate(function(key,value){value.setParentAddress(addr);});};proto.renameValue=function(oldKey,newKey,index){var value=CHashList.prototype.removeValue.call(this,oldKey);var result=CHashList.prototype.setValue.call(this,newKey,value,index);return result;};proto.setValue=function(key,value,index){var result=CHashList.prototype.setValue.call(this,key,value,index);if(ecma.util.isa(value,ecma.hubb.Node)){value.setParentNode(this);var myAddress=this.getAddress();var valueAddress=value.getAddress();if(myAddress&&!valueAddress){value.setAddress(js.data.addr_join(myAddress,key));}}
return result;};proto.sortByKey=function(keys){if(keys.length!==this.indicies.length)throw new Error('Length mis-match');var myKeys=this.keys();var indicies=[];var hasChanged=false;for(var i in keys){var key=keys[i];indicies.push(key);if(myKeys[i]!=keys[i])hasChanged=true;}
if(hasChanged){this.indicies=indicies;this.executeAction({'name':'update','updated':{'order':true}},this);}};proto.removeValue=function(key){var result=CHashList.prototype.removeValue.call(this,key);if(result){result.executeAction('remove',result);return result;}};proto.crop=function(keys){var myKeys=this.keys();var count=0;for(var i=0;i<myKeys.length;i++){var key=myKeys[i];if(!ecma.util.grep(key,keys)){this.removeValue(key);count++;}}
return count;};proto.merge=function(value){if(value.isDirectory()){this.crop(value.keys());var index=0;value.iterate(function(itemKey,itemValue){var myValue=this.getValue(itemKey);if(myValue){var mtime=itemValue.getAttribute('mtime');if(mtime)myValue.setAttribute('mtime',mtime);var type=itemValue.getType();if(type!=myValue.getType()){this.removeValue(itemKey);this.setValue(itemKey,itemValue,index);this.executeAction('create',itemValue,'change type '+itemKey);myValue=this.getValue(itemKey);}}else{this.setValue(itemKey,itemValue);this.executeAction('create',itemValue,'new stub '+itemKey);}
index++;},this);}else{var rmCount=this.crop(value.keys());var index=0;value.iterate(function(k,v){var myValue=this.getValue(k);if(js.util.isDefined(myValue)){myValue.merge(v);}else{this.setValue(k,v,index);var action='create';this.executeAction(action,v);if(ecma.util.isFunction(v.walk)){v.walk(function(key,val,depth,addr,pval){pval.executeAction(action,val);});}}
index++;},this);}
return CNode.prototype.merge.apply(this,arguments);};});ECMAScript.Extend('hubb',function(ecma){var CNode=ecma.hubb.Node;var CActionDispatcher=ecma.action.ActionDispatcher;this.ScalarNode=function(value){CNode.call(this);this.value=value;};var ScalarNode=ecma.lang.createPrototype(CNode);this.ScalarNode.prototype=ScalarNode;ScalarNode.dispatchAction=function(){var invoker=CActionDispatcher.prototype.dispatchAction;this.invokeAction(invoker,true,arguments);};proto.renameValue=function(oldKey,newKey,index){throw new Error('Scalar nodes do not contain children');};ScalarNode.setValue=function(value){return this.value=value;};ScalarNode.getValue=function(){if(ecma.util.defined(arguments[0]))return;return this.value;};ScalarNode.toString=function(){if(ecma.util.defined(arguments[0]))return;return this.getValue();};ScalarNode.toObject=function(){if(ecma.util.defined(arguments[0]))return;return this.getValue();};ScalarNode.toXFR=function(){return'${'+ecma.data.xfr.encodeComponent(this.getValue())+'}';};ScalarNode.getContent=function(){return this.getValue();};ScalarNode.merge=function(scalar){var sv=scalar.getValue();if(this.value!=sv){this.value=sv;this.dispatchAction('change',this);};return CNode.prototype.merge.apply(this,arguments);};ScalarNode.tie=function(elem,attrs,styles){function onChange(action,sv){var value=sv.getValue();if(attrs){for(var i=0,attr;attr=attrs[i];i++){ecma.dom.setAttribute(elem,attr,value);}}
if(styles){for(var i=0,style;style=styles[i];i++){ecma.dom.setStyle(elem,style,value);}}}
onChange(null,this);return this.addActionListener('onChange',onChange);};});ECMAScript.Extend('hubb',function(ecma){var CHashNode=ecma.hubb.HashNode;this.RootNode=function(db,addr){CHashNode.apply(this);this.setAttribute('addr',addr);this.setAttribute('type','directory');this.db=db;};var proto=ecma.lang.createPrototype(ecma.hubb.HashNode);this.RootNode.prototype=proto;proto._fetch=function(addr,cb){arguments[0]=this.db.relativeAddress(addr);this.db.fetch.apply(this.db,arguments);};});ECMAScript.Extend('hubb',function(ecma){var CXFR=ecma.data.XFR;var proto=ecma.lang.createPrototype(CXFR);this.XFR=function(encoding){CXFR.apply(this,arguments);};this.XFR.prototype=proto;proto.symbolToClass=function(symbol){return symbol=='%'?ecma.hubb.HashNode:symbol=='@'?ecma.hubb.ArrayNode:symbol=='$'?ecma.hubb.ScalarNode:null;};proto.createValue=function(symbol,value){var klass=this.symbolToClass(symbol);if(klass===String)return value;return new klass(value);};});ECMAScript.Extend('hubb',function(ecma){var _db=new Object();this.getInstance2=function(addr){if(!addr)addr='/';var db=_db[addr];if(!db){db=_db[addr]=new ecma.hubb.DataBridge(addr);}
return db;};this.getInstance=function(addr){if(!addr)addr='/';var db=_db[addr];if(!db){var win=ecma.window.top;if(win&&win.js&&win.js.hubb){if(win.js.id!=ecma.id){return win.js.hubb.getInstance(addr);}}
if(!db){db=_db[addr]=new ecma.hubb.DataBridge(addr);}}
return db;};var CActionDispatcher=ecma.action.ActionDispatcher;this.DataBridge=function(addr){CActionDispatcher.apply(this);this.validateAddress(addr);this.rootAddress=addr;this.root=new ecma.hubb.RootNode(this,this.rootAddress);this.monitor=new js.util.Monitor();this.monitor.setParameter('min_interval',5000);this.monitor.setParameter('elapsed_multiplier',3);this.monitor.addTarget(this,'autoRefresh');};var DataBridge=ecma.lang.createPrototype(CActionDispatcher);this.DataBridge.prototype=DataBridge;DataBridge.getRoot=function(){return this.root;};DataBridge.getNodeByAddress=function(addr){return addr==this.rootAddress?this.root:this.root.get(this.relativeAddress(addr));};DataBridge.validateAddress=function(addr){try{ecma.lang.assert(addr);ecma.lang.assert(addr.match(/^\//));ecma.lang.assert(addr==ecma.data.addr_normalize(addr));}catch(ex){throw new Error('Address is not valid: '+addr);}};DataBridge.absoluteAddress=function(addr){if(addr.indexOf(this.rootAddress)==0)return addr;return ecma.data.addr_join(this.rootAddress,addr);};DataBridge.relativeAddress=function(addr){if(!addr.indexOf(this.rootAddress)==0)return addr;return addr.substr(this.rootAddress.length);};DataBridge.createStubNode=function(addr,type,mtime){var stub=new ecma.hubb.HashNode();stub.setAttribute('addr',addr);stub.setAttribute('type',type||'unknown');stub.setAttribute('mtime',mtime||'0');return stub;};DataBridge.get=function(addr,cb){var node=this.getNodeByAddress(addr);if(node&&node.hasFetched()){ecma.lang.callback(cb,null,[node]);}else{this.fetch(addr,cb);}};DataBridge.getAndFetch=function(addr,cb){var node=this.getNodeByAddress(addr);if(node&&node.hasFetched()){if(cb)ecma.lang.callback(cb,null,[node]);this.fetch(addr);}else{this.fetch(addr,cb);}};DataBridge.fetch=function(addr,cb){addr=this.absoluteAddress(addr);this.validateAddress(addr);var datum=this.getNodeByAddress(addr);var headers={'Cache-Control':'no-fetch'};var params={'root':this.rootAddress};if(datum){var mdate=datum.getModifiedDate();if(mdate){headers['If-Modified-Since']=mdate.toUTCString();headers['Cache-Control']='max-age=0; must-revalidate';}}
_xcmd.call(this,'fetch',addr,addr,headers,params,cb);};DataBridge.store=function(addr,value,cb){addr=this.absoluteAddress(addr);this.validateAddress(addr);var datum=this.getNodeByAddress(addr);var mtime=datum?datum.getTimestamp():'0';var params={'value':value,'mtime':mtime};_xcmd.call(this,'store',addr,addr,null,params,cb);};DataBridge.update=function(){var args=_args(['target','values'],arguments);var params=args.shift();var cb=args.shift();params.target=this.absoluteAddress(params.target);this.validateAddress(params.target);_xcmd2.call(this,'update',null,params,cb);};function _args(names,args){args=ecma.util.args(args);if(!ecma.util.isAssociative(args[0])){var params={};for(var i=0;i<names.length;i++){params[names[i]]=args.shift();}
args.unshift(params);}
return args;}
DataBridge.create=function(){var args=_args(['target','name','type'],arguments);var params=args.shift();var cb=args.shift();var name=params.name;var addr=this.absoluteAddress(params.target);this.validateAddress(addr);var addr2=ecma.data.addr_join(addr,name);this.validateAddress(addr2);if(ecma.data.addr_parent(addr2)!=addr)throw new Error('Invalid name');var datum=this.getNodeByAddress(addr2);if(datum)throw new Error('Node already exists');_xcmd2.call(this,'create',null,params,cb);};DataBridge.insert=function(addr,index,src,cb){addr=this.absoluteAddress(addr);this.validateAddress(addr);var xcmd=ecma.lsn.hubb.command.createInstance('insert',addr,index,src);if(!this.isContiguous(addr))xcmd.setParameter('branch',1);xcmd.addActionListener('fixup',_onFixup,this);xcmd.addActionListener('remove',_onRemove,this);xcmd.addActionListener('complete',_onComplete,this);xcmd.submit(cb);};DataBridge.remove=function(addr,cb){addr=this.absoluteAddress(addr);this.validateAddress(addr);_xcmd.call(this,'remove',addr,addr,null,null,cb);};DataBridge.rename=function(){var args=_args(['target','name'],arguments);var params=args.shift();var cb=args.shift();params.target=this.absoluteAddress(params.target);this.validateAddress(params.target);_xcmd2.call(this,'rename',null,params,cb);};DataBridge.copy=function(addr,dest,cb){addr=this.absoluteAddress(addr);this.validateAddress(addr);this.validateAddress(dest);ecma.lang.assert(addr!=dest);var params={'dest':dest};_xcmd.call(this,'copy',addr,dest,null,params,cb);};DataBridge.move=function(addr,dest,cb){addr=this.absoluteAddress(addr);this.validateAddress(addr);dest=this.absoluteAddress(dest);this.validateAddress(dest);ecma.lang.assert(addr!=dest);var params={'dest':dest};_xcmd.call(this,'move',addr,dest,null,params,cb);};DataBridge.progress=function(addr,name,id,type,cb){var pnode=this.getNodeByAddress(addr);var addr2=ecma.data.addr_join(addr,name);var stub=this.createStubNode(addr2,'loading');if(pnode)pnode.replaceValue(name,stub);var xcmd=ecma.lsn.hubb.command.createInstance('progress');xcmd.setParameter('id',id);xcmd.setParameter('target',addr2);xcmd.setParameter('type',type);xcmd.addActionListener('status',function(action,stats){var node=stub||this;node.dispatchAction(action,stats);},this);xcmd.addActionListener('complete',function(action){this.fetch(addr2,cb);},this);xcmd.submit();};DataBridge.download=function(addr,name,uri,bReplace,cb){var replace=bReplace?'1':'0';addr=this.absoluteAddress(addr);this.validateAddress(addr);var addr2=ecma.data.addr_join(addr,name);this.validateAddress(addr2);if(ecma.data.addr_parent(addr2)!=addr)throw new Error('Invalid name');var datum=this.getNodeByAddress(addr2);if(datum&&!bReplace)throw new Error('Node already exists');var params={'name':name,'uri':uri,'replace':replace};var id=ecma.util.randomId();var headers={'X-Progress-ID':id};_xcmd.call(this,'download',addr,addr2,headers,params);this.progress(addr,name,id,'download',cb);};DataBridge.reorder=function(addr,value,cb){addr=this.absoluteAddress(addr);this.validateAddress(addr);var params={'value':value};_xcmd.call(this,'reorder',addr,addr,null,params,cb);};DataBridge.isContiguous=function(addr){if(!addr)return false;try{var parentAddr=ecma.data.addr_parent(addr);var parentNode=this.getNodeByAddress(parentAddr);var mtime=parentNode.getStorage().getAttribute('mtime');return ecma.util.asInt(mtime)>0;}catch(ex){return false;}};DataBridge.batch=function(values,cb){var xcmd=ecma.lsn.hubb.command.createInstance('batch');var branching={};for(var i=0,args;args=values[i];i++){if(!ecma.util.isArray(args))throw new Error('provide an array of arrays');var cmd=xcmd.addCommand.apply(xcmd,args);var addr=cmd.getParameters()['target'];if(!this.isContiguous(addr)){var parentAddr=ecma.data.addr_parent(addr);if(!branching[parentAddr]){cmd.setParameter('branch',1);branching[parentAddr]=1;}}
cmd.addActionListener('fixup',_onFixup,this);cmd.addActionListener('reorder',_onReorder,this);cmd.addActionListener('remove',_onRemove,this);cmd.addActionListener('rename',_onRename,this);}
xcmd.addActionListener('complete',_onComplete,this);xcmd.submit(cb);};DataBridge.startAutoRefresh=function(){this.monitor.start(true);};DataBridge.stopAutoRefresh=function(){this.monitor.stop();};DataBridge.autoRefresh=function(){var root=this.getRoot();var commands=[];root.walk(function(key,node){if(node.hasFetched()&&(node.isDirectory()||node.isFile())){commands.push(['fetch',node.getAddress()]);}});this.batch(commands,[function(){this.monitor.resume();},this]);};function _xcmd(verb,addr,dest,headers,values,cb){var xcmd=ecma.lsn.hubb.command.createInstance(verb);xcmd.addActionListener('fixup',_onFixup,this);xcmd.addActionListener('reorder',_onReorder,this);xcmd.addActionListener('remove',_onRemove,this);xcmd.addActionListener('rename',_onRename,this);xcmd.addActionListener('complete',_onComplete,this);if(!values)values={};if(addr){values.target=addr;xcmd.addr=addr;}
xcmd.setParameters(values);xcmd.setHeaders(headers);if(!this.isContiguous(dest))xcmd.setParameter('branch',1);xcmd.submit(cb);}
function _xcmd2(verb,headers,params,cb){var xcmd=ecma.lsn.hubb.command.createInstance(verb);xcmd.addActionListener('fixup',_onFixup,this);xcmd.addActionListener('reorder',_onReorder,this);xcmd.addActionListener('remove',_onRemove,this);xcmd.addActionListener('rename',_onRename,this);xcmd.addActionListener('complete',_onComplete,this);xcmd.addr=params.target;xcmd.setParameters(params);xcmd.setHeaders(headers);if(!this.isContiguous(params.target))xcmd.setParameter('branch',1);xcmd.submit(cb);}
function _onComplete(action,xcmd){if(xcmd.verb=='remove')return;if(xcmd.verb=='rename')return;this.executeAction(xcmd.verb,xcmd.result);}
function _onRemove(action,addr,meta){if(meta&&meta.mtime){var parentAddr=ecma.data.addr_parent(addr);var parentNode=this.getNodeByAddress(parentAddr);if(parentNode){var storage=parentNode.getStorage();if(storage&&storage.isFile()){storage.reload();}}}
var xnode=this.getNodeByAddress(addr);if(xnode){try{xnode.getParentNode().removeValue(xnode.getKey());}catch(ex){}finally{this.executeAction('remove',xnode);}}}
function _onRename(action,meta){var node=this.getNodeByAddress(meta.old_addr);if(node){try{action.dispatcher.result=node;node.mergeRename(meta);}catch(ex){}finally{this.executeAction('rename',node);}}
var storage=this.getNodeByAddress(meta.storage_addr);if(storage&&storage.isFile()){storage.reload();}}
function _onReorder(action,addr,keys,meta){var xcmd=action.dispatcher;var node=this.getNodeByAddress(addr);if(node){node.sortByKey(keys);node.getStorage().setAttribute('mtime',meta.mtime);xcmd.result=node;}}
function _onFixup(action,node){var xcmd=action.dispatcher;if(!node)return;var addr=node.getAddress();var currentNode=this.getNodeByAddress(addr);var nodeMtime=ecma.util.asInt(node.getAttribute('mtime'));var hasModified=false;var storage;if(currentNode){var nodeSum=node.getAttribute('checksum');var currentMtime=ecma.util.asInt(currentNode.getTimestamp());if(nodeSum){var currentSum=currentNode.getAttribute('checksum');if(currentSum!==nodeSum){currentNode.merge(node);hasModified=true;}else{if(!currentMtime||(currentMtime<nodeMtime)){currentNode.setAttribute('mtime',nodeMtime);hasModified=true;}}}else{if(!currentMtime||(currentMtime<nodeMtime)){currentNode.merge(node);hasModified=true;}}
storage=currentNode.getStorage();}else{var parentAddr=ecma.data.addr_parent(addr);var parentNode=this.getNodeByAddress(parentAddr);if(parentNode){var key=ecma.data.addr_name(addr);currentNode=parentNode.createValue(key,node);storage=parentNode.getStorage();hasModified=true;}else{}}
if(hasModified&&storage&&storage!==currentNode&&storage.isFile()){storage.reload();}
xcmd.result=currentNode;}});ECMAScript.Extend('hubb.ui',function(ecma){this.createInput=function(node){var type=node.getType();var obj=undefined;switch(type){case'data-scalar-bool':obj=new ecma.hubb.ui.input.InputBoolean(node);break;case'data-scalar-txt':obj=new ecma.hubb.ui.input.InputTextarea(node);break;default:obj=new ecma.hubb.ui.input.InputText(node);}
return obj;};});ECMAScript.Extend('hubb.ui',function(ecma){var CAction=ecma.action.ActionDispatcher;var _proto=ecma.lang.createPrototype(CAction);this.FileList=function(rootAddr,canvasURL){CAction.apply(this);this.ui={};this.rootAddr=rootAddr;this.canvasURL=canvasURL||'/res/var/blank.html';this.filters=[];this.db=ecma.hubb.getInstance();this.db.fetch(this.rootAddr,[this.onFetch,this]);};this.FileList.prototype=_proto;_proto.onFetch=function(dnode){if(!dnode)return;if(!this.ui.root)this.createUI();dnode.iterate(this.createItem,this);};_proto.createItem=function(name,dnode){if(!this.applyFilters(name))return;this.createFile(dnode);};_proto.createFile=function(dnode){var file=new ecma.hubb.ui.FileItem(this.rootAddr,dnode,this.canvasURL);file.addActionListener('updateUI',this.updateUI,this);file.addActionListener('click',this.doClick,this);this.ui.items.appendChild(file.getRootElement());};_proto.getRootElement=function(){if(!this.ui.root)this.createUI();return this.ui.root;};_proto.createUI=function(){this.ui.items=ecma.dom.createElement('div.items');this.ui.btnAdd=ecma.dom.createElement('a=Add a file',{'href':'#doAddFile','onClick':[this.doAddFile,this]});this.ui.root=ecma.dom.createElement('div',[this.ui.items,'div.add',[this.ui.btnAdd]]);};_proto.updateUI=function(){if(this.ui.items.childNodes.length>0){ecma.dom.setValue(this.ui.btnAdd,'Add another file');ecma.dom.addClassName(this.ui.btnAdd.parentNode,'addanother');}else{ecma.dom.setValue(this.ui.btnAdd,'Add a file');ecma.dom.removeClassName(this.ui.btnAdd.parentNode,'addanother');}
this.dispatchAction('updateui');};_proto.doAddFile=function(event){ecma.dom.stopEvent(event);this.createFile();};_proto.addFilter=function(){var cb=ecma.lang.createCallbackArray(arguments);this.filters.push(cb);};_proto.applyFilters=function(name){var result=true;ecma.util.step(this.filters,function(cb){if(result)result=ecma.lang.callback(cb,null,[name]);});return result;};_proto.doClick=function(action,dnode){this.dispatchAction('click',dnode);};});ECMAScript.Extend('hubb.ui',function(ecma){var CAction=ecma.action.ActionDispatcher;this.FileItem=function(rootAddr,dnode,canvasURL){CAction.apply(this);this.rootAddr=rootAddr;this.fileAddr=null;this.fileName=null;this.canvasURL=canvasURL;this.dnode=dnode;this.hasCancelled=false;this.ui={};this.db=ecma.hubb.getInstance();this.db.addActionListener('create',this.onDataAction,this);this.db.addActionListener('update',this.onDataAction,this);this.db.addActionListener('remove',this.onDataRemoved,this);this.db.addActionListener('status',this.onUploadStatus,this);};var _proto=this.FileItem.prototype=ecma.lang.createPrototype(CAction);_proto.getRootElement=function(){this.createUI();if(this.dnode){this.fileAddr=this.dnode.getAddress();this.fileName=this.dnode.getKey();this.createDisplayUI();}else{this.createUploadUI();}
this.updateUI();return this.ui.root;};_proto.getFilename=function(){if(this.fileName)return this.fileName;var value=this.js2.dom.getValue(this.ui.ctrl);if(!value)return;var fileName=value.replace(/\\/g,'/');var idx=fileName.lastIndexOf('/');idx=ecma.util.defined(idx)?idx+1:0;fileName=fileName.substr(idx);return fileName;};_proto.createUI=function(){if(this.ui.root)return;this.ui.root=ecma.dom.createElement('div.item');};_proto.createUploadUI=function(){this.ui.iframe=ecma.dom.createElement('iframe',{'src':this.canvasURL,'frameborder':'0','allowtransparency':true,'style':{'background-color':'transparent','width':'100%','height':'30px'}});this.evtLoad=new ecma.dom.EventListener(this.ui.iframe,'load',this.onIframeLoad,this);ecma.dom.replaceChildren(this.ui.root,[this.ui.iframe]);};_proto.onIframeLoad=function(){this.evtLoad.remove();delete this.evtLoad;var doc=ecma.dom.getContentDocument(this.ui.iframe);var win=ecma.dom.getContentWindow(this.ui.iframe);this.js2=new ECMAScript.Class(win,doc);this.ui.ctrl=this.js2.dom.createElement('input.file',{'type':'file','name':'file','onChange':[this.doUploadFile,this]});this.ui.form=this.js2.dom.createElement('form.upload',{'method':'POST','enctype':'multipart/form-data'},[this.ui.ctrl,'#text= ','small',['#text=(maximum 60Mb) (','a.lnk=Cancel',{'onClick':[this.doRemoveForm,this]},'#text=)']]);try{this.ui.form.encoding='multipart/form-data';}catch(ex){}
var body=this.js2.dom.getBody();var css=new this.js2.dom.StyleSheet();css.updateRules('html, html body, form','background-color:transparent;');css.updateRules('html, html body, form','margin:0;padding:0;');css.updateRules('html, html body','overflow:hidden;height:30px;');css.updateRule('a.lnk','cursor:pointer;');body.appendChild(this.ui.form);var h=this.js2.dom.getHeight(body);ecma.dom.setStyle(this.ui.iframe,'height',h+'px');};_proto.createDisplayUI=function(){this.ui.icon=ecma.dom.createElement('img.icon');this.ui.fileName=ecma.dom.createElement('span.fileName');this.ui.remove=ecma.dom.createElement('a',{'class':'lnk action','onClick':[this.doRemoveFile,this]});this.ui.anchor=ecma.dom.createElement('a',{'class':'lnk open','href':this.fileAddr,'onClick':[this.doClick,this]},[this.ui.icon,this.ui.fileName]);;this.ui.actions=ecma.dom.createElement('span.actions',['#text= (',this.ui.remove,'#text=)']);this.ui.display=ecma.dom.createElement('div',[this.ui.anchor,this.ui.actions]);ecma.dom.setStyle(this.ui.iframe,'display','none');ecma.dom.appendChildren(this.ui.root,[this.ui.display]);};_proto.isUploading=function(){return this.dnode&&this.dnode.getType()=='loading';};_proto.updateUI=function(){if(this.ui.display&&this.dnode){ecma.dom.setAttribute(this.ui.icon,'src',this.dnode.getIcon());if(this.isUploading()){ecma.dom.setValue(this.ui.fileName,'(0%) '+this.fileName);ecma.dom.setValue(this.ui.remove,'Cancel');}else{ecma.dom.setValue(this.ui.fileName,this.dnode.getKey());ecma.dom.setValue(this.ui.remove,'Remove');}}
this.dispatchAction('updateUI',this);};_proto.doRemoveForm=function(event){ecma.dom.stopEvent(event);ecma.dom.removeElement(this.ui.root);this.updateUI();};_proto.doUploadFile=function(event){var fileName=this.getFilename();if(!fileName)return;var addr=this.rootAddr+'/'+fileName;if(this.db.getNodeByAddress(addr)){alert(fileName+' already exists!');this.ui.form.reset();return;}
var id=ecma.util.randomId();this.fileAddr=addr;this.fileName=fileName;this.ui.form.action='/api/hub/upload?'
+'X-Progress-ID='+id
+'&target='+encodeURIComponent(this.rootAddr)
+'&name='+encodeURIComponent(fileName);+'&replace=0';this.ui.form.submit();this.db.progress(this.rootAddr,fileName,id,'upload',[this.onUploaded,this]);};_proto.doRemoveFile=function(event){ecma.dom.stopEvent(event);if(this.isUploading()){if(confirm('Really cancel the upload of: '+this.fileName)){ecma.dom.removeElement(this.ui.iframe);this.ui.iframe=null;this.hasCancelled=true;ecma.dom.removeElement(this.ui.actions);}}else{if(confirm('Do you really want to delete: '+this.fileName)){this.db.remove(this.fileAddr);}}};_proto.doClick=function(event){ecma.dom.stopEvent(event);if(this.isUploading()||this.hasCancelled)return;var elem=js.dom.getEventTarget(event);if(elem)elem.blur();this.dispatchAction('click',this.dnode);};_proto.onUploaded=function(dnode){if(this.hasCancelled){if(dnode)this.db.remove(this.fileAddr);return;}
if(!dnode){alert('Upload Failed: '+this.fileName);}else{ecma.dom.removeElement(this.ui.iframe);}};_proto.onDataAction=function(action,dnode){var addr=dnode.getAddress();if(addr!=this.fileAddr)return;if(!this.dnode)this.dnode=dnode;if(!this.ui.display){this.createDisplayUI();}
this.updateUI();};_proto.onUploadStatus=function(action,stats){if(stats.addr!=this.fileAddr)return;var prefix=this.hasCancelled?'(Cancelling...) ':'('+stats.percent+'%) ';ecma.dom.setValue(this.ui.fileName,prefix+this.fileName);};_proto.onDataRemoved=function(action,dnode){var addr=dnode.getAddress();if(addr!=this.fileAddr)return;if(this.ui.root)ecma.dom.removeElement(this.ui.root);this.updateUI();};});ECMAScript.Extend('hubb.ui',function(ecma){var STATE_CANNOT_EXPAND=0;var STATE_EXPANDED=1;var STATE_COLLAPSED=2;var STATE_IS_EMPTY=3;this.TreeNode=function(data,view,name,depth){ecma.data.Node.call(this,data);this.view=view;this.name=name;this.depth=depth;this.state=STATE_CANNOT_EXPAND;this.isPopulated=false;this.isVisible=false;this.createUI();this.updateUI();this.uiDate=null;};var proto=ecma.lang.createPrototype(ecma.data.Node);this.TreeNode.prototype=proto;proto.createNode=function(data,view,name,depth){return new ecma.hubb.ui.TreeNode(data,view,name,depth);};proto.getNodeByAddress=function(addr){var myAddr=this.data.getAddress();if(myAddr==addr)return this;if(addr.indexOf(myAddr)!=0)return null;return this.walk(function(tnode){if(tnode.data.getAddress()==addr){return tnode;}},this);};proto.getAddress=function(){return this.data.getAddress();};proto.getChildByName=function(name){if(!ecma.util.defined(name)||name=='')return this;var n=this.firstChild;while(n){if(n.name==name)return n;n=n.nextSibling;}};proto.createUI=function(){this.ui={};this.ui.toggle=ecma.dom.createElement('img',{'class':'toggle','src':ecma.hubb.getIconByName('noexp.png')});this.ui.icon=ecma.dom.createElement('img',{'class':'icon','src':this.data.getIcon()});this.ui.name=ecma.dom.createElement('span',{'class':'name','innerHTML':this.name});var paddingLeft=this.depth?(((16+3)*this.depth)-3):0;this.ui.row=ecma.dom.createElement('tr',['th',{'style':{'padding-left':paddingLeft+'px'}},[this.ui.toggle,this.ui.icon,this.ui.name]]);this.ui.detail=[];for(var i=0;i<this.view.detailColumns.length;i++){var td=ecma.dom.createElement('td',{'class':'detail'+i});this.ui.row.appendChild(td);this.ui.detail[i]=td;}
this.ui.events=[new ecma.dom.EventListener(this.ui.row,'click',this.onClick,this),new ecma.dom.EventListener(this.ui.row,'dblclick',this.onDblClick,this),new ecma.dom.EventListener(this.ui.row,'select',function(){return false;}),new ecma.dom.EventListener(this.ui.row,'selectstart',function(){return false;}),new ecma.dom.EventListener(this.ui.row,'mousedown',function(){return false;}),];};proto.refreshUI=function(){var mdate=this.data.getDate();if((!this.uiDate&&mdate)||(this.uiDate&&this.uiDate<mdate)){this.updateUI();}
if(this.parentNode){var prevDNode=this.data.getPreviousSibling();var prevTNode=prevDNode?this.parentNode.getNodeByAddress(prevDNode.getAddress()):null;if(prevTNode&&prevTNode!==this.previousSibling){this.parentNode.insertAfter(this,prevTNode);this.show(prevTNode.getElement(),true);}}};proto.updateUI=function(){if(this.view.canExpand(this)){if(this.state==STATE_CANNOT_EXPAND){this.setState(STATE_COLLAPSED);this.ui.toggleEvent=new ecma.dom.EventListener(this.ui.toggle,'click',this.toggle,this);ecma.dom.addClassName(this.ui.toggle,'canexp');this.isPopulated=false;}}else{if(this.state!=STATE_CANNOT_EXPAND){this.setState(STATE_CANNOT_EXPAND);if(this.ui.toggleEvent){this.ui.toggleEvent.remove()
this.ui.toggleEvent=null;}
for(var child=this.firstChild;child;child=child.nextSibling){child.remove();}}}
var uiIcon=ecma.dom.getAttribute(this.ui.icon,'src');var dataIcon=this.data.getIcon();if(uiIcon!=dataIcon){ecma.dom.setAttribute(this.ui.icon,'src',dataIcon);}
var uiName=ecma.dom.getValue(this.ui.name);if(uiName!=this.name){ecma.dom.setValue(this.ui.name,this.name);}
for(var i=0;i<this.ui.detail.length;i++){var td=this.ui.detail[i];var cb=this.view.detailColumns[i];ecma.lang.callback(cb,null,[this.data,td]);this.ui.row.appendChild(td);}
this.uiDate=this.data.getDate();};proto.destroyUI=function(){for(var i=0,evt;evt=this.ui.events[i];i++){evt.remove();}
this.ui.events=[];if(this.ui.toggleEvent){this.ui.toggleEvent.remove()
this.ui.toggleEvent=null;}
ecma.dom.removeElement(this.getElement());};proto.onClick=function(event){this.view.onClick(event,this);};proto.onDblClick=function(event){this.view.onDblClick(event,this);};proto.getElement=function(){return this.ui.row;};proto.setState=function(state){var name=state==STATE_CANNOT_EXPAND?'noexp.png':state==STATE_EXPANDED?'isexp.png':state==STATE_COLLAPSED?'canexp.png':state==STATE_IS_EMPTY?'isempty.png':null;ecma.lang.assert(name!=null);var src=ecma.hubb.getIconByName(name);ecma.dom.setAttribute(this.ui.toggle,'src',src);this.state=state;};proto.toggle=function(event){if(event)ecma.dom.stopEvent(event);if(this.state==STATE_EXPANDED){this.collapse();}else if(this.state==STATE_COLLAPSED){this.expand();}else if(this.state==STATE_IS_EMPTY){this.expand();}};proto.expand=function(){if(this.state==STATE_EXPANDED)return;if(!this.isPopulated){if(!this.data.hasFetched()){this.data.fetch([function(){if(this.data.hasFetched())return this.expand();this.setState(STATE_IS_EMPTY);},this]);return;}else{this.populate();}}
if(this.hasChildNodes()){var y=this;var x=this.firstChild;while(x){y=x.show(y.getElement());x=x.nextSibling;}
this.setState(STATE_EXPANDED);}else{this.setState(STATE_IS_EMPTY);}
this.isVisible=true;this.data.fetch();};proto.populate=function(){this.data.iterate(function(k,v){if(this.view.canDisplay(v)){this.appendChild(new ecma.hubb.ui.TreeNode(v,this.view,k,this.depth+1));}},this);this.isPopulated=true;};proto.collapse=function(){if(!this.state==STATE_EXPANDED)return;var node=this.firstChild;while(node){node.hide();node=node.nextSibling;}
this.setState(STATE_COLLAPSED);this.view.onCollapse();};proto.hide=function(){for(var node=this.firstChild;node;node=node.nextSibling){node.hide();}
ecma.dom.removeElement(this.getElement());this.isVisible=false;};proto.show=function(precedingElement,bUpdate){if(this.isVisible&&!bUpdate)return;var y=this;ecma.dom.insertAfter(y.getElement(),precedingElement);this.isVisible=true;if(this.state==STATE_EXPANDED){for(var x=this.firstChild;x;x=x.nextSibling){y=x.show(y.getElement());}}
return y;};proto.reindex=function(){var child=this.firstChild;while(child){child.name=ecma.data.addr_name(child.data.getAddress());ecma.dom.setValue(child.ui.name,child.name);child.reindex();child=child.nextSibling;}
return this;};proto.remove=function(){this.destroyUI();while(this.hasChildNodes()){this.firstChild.remove();}
var pnode=this.parentNode;if(pnode){var isEmpty=(!this.previousSibling&&!this.nextSibling);pnode.removeChild(this);if(isEmpty)pnode.setState(STATE_IS_EMPTY);}};proto.replace=function(dnode){this.data=dnode;this.updateUI();};proto.createChild=function(dnode){if(!this.isPopulated)return;var tnode=this.getNodeByAddress(dnode.getAddress());if(tnode){if(tnode.data.getType()!=dnode.getType()){tnode.replace(dnode);}
return tnode;}
if(!this.view.canDisplay(dnode))return;var name=ecma.data.addr_name(dnode.getAddress());tnode=new ecma.hubb.ui.TreeNode(dnode,this.view,name,this.depth+1);var prevDNode=dnode.getPreviousSibling();var prevTNode=prevDNode?this.getNodeByAddress(prevDNode.getAddress()):null;if(prevTNode){this.insertAfter(tnode,prevTNode);}else if(this.firstChild){this.insertBefore(tnode,this.firstChild);prevTNode=this;}else{this.appendChild(tnode);prevTNode=this;}
if(this.isVisible){if(this.state==STATE_IS_EMPTY){this.expand();}
if(this.state==STATE_EXPANDED){tnode.show(prevTNode.getElement());}}
return tnode;};});ECMAScript.Extend('hubb.ui',function(ecma){this.TreeView=function(addr){ecma.action.ActionDispatcher.apply(this);this.id=ecma.util.incrementalId('TreeView');this.db=ecma.hubb.getInstance();this.root=null;this.rootAddress='/';this.ui={};this.ui.inner=ecma.dom.createElement('tbody');this.ui.outer=ecma.dom.createElement('table',{'class':'hublist'},[this.ui.inner]);this.selection=[];this.detailColumns=[];ecma.hubb.ui.initStyles();if(addr)this.setRootAddress(addr);};var proto=ecma.lang.createPrototype(ecma.action.ActionDispatcher);this.TreeView.prototype=proto;proto.getRootAddress=function(){return this.rootAddress;};proto.setRootAddress=function(addr){var newAddr=ecma.data.addr_normalize(addr);if(newAddr!=addr)throw new Error('Root address is not normalized');this.rootAddress=newAddr;if(this.root){this.root.remove();this.root=null;this.deselect();this.initRoot();}};proto.getElement=function(){return this.ui.outer;};proto.getScrollableParent=function(){var elem=this.ui.outer;var elemScroll=null;var body=ecma.dom.getBody();while(!elemScroll&&elem){var overflow=ecma.dom.getStyle(elem,'overflow');if(overflow&&overflow.match(/auto|scroll/i)){elemScroll=elem;}else{elem=elem==body?null:elem.parentNode;}}
return elemScroll||body;};proto.expand=function(addr,cb){if(addr.indexOf(this.rootAddress)!=0)throw new Error('Address outside of root');var tnode=this.getNodeByAddress(addr);if(tnode){this.onExpand(tnode.data,cb);}else{this.db.fetch(addr,[this.onExpand,this,[cb]]);}};proto.onExpand=function(dnode,cb){this.initRoot();var addr=dnode.getAddress().substr(this.rootAddress.length);var parts=ecma.data.addr_split(addr);var tnode=this.root;for(var i=0;i<parts.length;i++){tnode=tnode.getChildByName(parts[i]);tnode.expand();}
if(cb)ecma.thread.spawn(cb,this,[dnode]);};proto.select=function(addr){if(addr.indexOf(this.rootAddress)!=0)throw new Error('Address outside of root');this.deselect();var tnode=this.getNodeByAddress(addr);if(tnode){this.onSelect(tnode.data);}else{this.db.fetch(addr,[this.onSelect,this]);}};proto.onSelect=function(dnode){if(!dnode)return;var pdnode=dnode.getParentNode()||dnode;this.onExpand(pdnode);var tnode=this.getNodeByAddress(dnode.getAddress());if(tnode){this.selectNode(tnode);this.scrollTo(tnode);}};proto.scrollTo=function(tnode){var se=this.getScrollableParent();var sh=ecma.dom.getHeight(se);var st=se.scrollTop;var te=tnode.getElement();var tt=ecma.dom.getTop(te)-ecma.dom.getTop(se);var tb=ecma.dom.getBottom(te)-ecma.dom.getTop(se);if(tb>(st+sh)||(tt<st)){se.scrollTop=ecma.util.asInt(tt-(sh/2));}};proto.destroy=function(){this.destroyRoot();this.destroyListeners();};proto.initRoot=function(){if(this.root)return;var dnode=this.db.root.get(this.rootAddress);this.root=new ecma.hubb.ui.TreeNode(dnode,this,this.rootAddress,0);var rootElem=this.root.getElement();this.ui.inner.appendChild(rootElem);this.root.expand();this.initListeners();};proto.destroyRoot=function(){if(this.root)this.root.remove();};proto.initListeners=function(){this.db.addActionListener('log',this.onLog,this);this.db.addActionListener('fetch',this.onFetch,this);this.db.addActionListener('create',this.onCreate,this);this.db.addActionListener('remove',this.onRemove,this);this.db.addActionListener('change',this.onChange,this);this.db.addActionListener('update',this.onUpdate,this);this.db.addActionListener('store',this.onStore,this);this.db.addActionListener('replace',this.onReplace,this);this.db.addActionListener('status',this.onStatus,this);};proto.destroyListeners=function(){this.db.removeActionListener('log',this.onLog,this);this.db.removeActionListener('fetch',this.onFetch,this);this.db.removeActionListener('create',this.onCreate,this);this.db.removeActionListener('remove',this.onRemove,this);this.db.removeActionListener('change',this.onChange,this);this.db.removeActionListener('update',this.onUpdate,this);this.db.removeActionListener('store',this.onStore,this);this.db.removeActionListener('replace',this.onReplace,this);this.db.removeActionListener('status',this.onStatus,this);};proto.getNodeByAddress=function(addr){return this.root?this.root.getNodeByAddress(addr):null;};proto.onCreate=function(action,dnode,msg){ecma.lang.assert(dnode);var pdnode=dnode.getParentNode();var ptnode=this.getNodeByAddress(pdnode.getAddress());if(ptnode)ptnode.createChild(dnode);};proto.onRemove=function(action,dnode,msg){var tnode=this.getNodeByAddress(dnode.getAddress());if(!tnode)return;this.deselectNode(tnode);tnode.remove();var pnode=tnode.parentNode;if(pnode&&ecma.util.isa(pnode.data,ecma.hubb.ArrayNode)){pnode.reindex();}};proto.onFetch=function(action,dnode,why){var tnode=this.getNodeByAddress(dnode.getAddress());if(!tnode)return;tnode.refreshUI();};proto.onChange=function(action,dnode){};proto.onUpdate=function(action,dnode){var tnode=this.getNodeByAddress(dnode.getAddress());if(!tnode)return;tnode.updateUI();};proto.onReplace=function(action,dnode){var tnode=this.getNodeByAddress(dnode.getAddress());if(!tnode)return;this.deselectNode(tnode);tnode.replace(dnode);};proto.onStore=function(action,dnode){};proto.onStatus=function(action,stats,msg){var tnode=this.getNodeByAddress(stats.addr);if(!tnode)return;ecma.dom.setValue(tnode.ui.name,'('+stats.percent+'%) '+tnode.name);};proto.onLog=function(action,dnode,msg){this.logMessage('LOG:',msg,dnode.getAddress());};proto.logMessage=function(){var args=ecma.util.args(arguments);args.unshift(this.id+':');ecma.console.log.apply(null,args);}
proto.onCollapse=function(tnode){var sel=this.getSelection();for(var i=0,n;n=sel[i];i++){if(!n.isVisible)this.deselectNode(n);}};proto.canExpand=function(tnode){return tnode.data.canExpand();};proto.canDisplay=function(dnode){return true;};proto.onClick=function(event,tnode){this.deselect();this.selectNode(tnode,event);ecma.dom.stopEvent(event);};proto.onDblClick=function(event,tnode){if(ecma.dom.browser.isOpera)ecma.dom.clearSelection();ecma.dom.stopEvent(event);tnode.toggle();};proto.getSelection=function(){return this.selection;};proto.getSelectedNode=function(){if(!this.selection.length)return null;return this.selection[this.selection.length-1];};proto.getFocusNode=function(){throw new Error('Not implemented');};proto.getAnchorNode=function(){return this.selection[0];};proto.selectNode=function(tnode,event){ecma.lang.assert(tnode!=null);ecma.dom.addClassName(tnode.getElement(),'selected');this.selection.push(tnode);this.dispatchAction('select',tnode);if(event){this.dispatchAction('userselect',tnode,event);}else{if(tnode.data.isDirectory())this.onExpand(tnode);this.dispatchAction('autoselect',tnode);}};proto.deselect=function(tnode){while(this.selection.length){this.deselectNode(this.selection[0]);}};proto.deselectNode=function(tnode){ecma.lang.assert(tnode!=null);ecma.dom.removeClassName(tnode.getElement(),'selected');for(var i=0,n;n=this.selection[i];i++){if(n===tnode){this.selection.splice(i,1);this.dispatchAction('deselect',tnode);break;}}};});ECMAScript.Extend('hubb.ui',function(ecma){var _cssId=ecma.util.randomId('css');this.initStyles=function(){var _css=ecma.dom.getElement(_cssId);if(_css)return;_css=new ecma.dom.StyleSheet(_cssId);_css.createRule('html',{'padding':'0','margin':'0'});_css.createRule('body',{'padding':'0','margin':'0'});_css.createRule('table.hublist',{'border-collapse':'collapse','width':'100%'});if(ecma.dom.browser.isGecko){_css.createRule('table.hublist',{'-moz-user-select':'none'});}else if(ecma.dom.browser.isWebKit){_css.createRule('table.hublist',{'-khtml-user-select':'none'});}
_css.createRule('table.hublist',{'padding':'0','margin':'0'});_css.createRule('table.hublist tr',{'padding':'0','margin':'0'});_css.createRule('table.hublist th',{'padding':'0','margin':'0'});_css.createRule('table.hublist td',{'padding':'0','margin':'0','white-space':'nowrap'});_css.createRule('table.hublist tr:hover span.name',{'text-decoration':'underline','cursor':'default'});_css.createRule('table.hublist tr.selected',{'background-color':'#fed'});_css.createRule('table.hublist th',{'text-align':'left','font-weight':'normal','white-space':'nowrap','line-height':'17px','width':'100%'});_css.createRule('table.hublist th span.name',{'vertical-align':'middle'});_css.createRule('table.hublist th img',{'vertical-align':'middle'});_css.createRule('table.hublist th img.icon',{'padding-left':'3px'});_css.createRule('table.hublist th span.name',{'padding-left':'3px'});_css.createRule('table.hublist img.canexp',{'cursor':'pointer'});};});ECMAScript.Extend('hubb.ui',function(ecma){var CTreeView=ecma.hubb.ui.TreeView;var proto=ecma.lang.createPrototype(CTreeView);this.TreeBox=function(rootAddr){CTreeView.apply(this,[rootAddr]);this.rootAddr=rootAddr;};this.TreeBox.prototype=proto;proto.canExpand=function(tnode){return tnode.data.isDirectory();};proto.onDblClick=function(event,tnode){if(!tnode.data.isDirectory()){this.hide();return CTreeView.prototype.selectNode.apply(this,[tnode,event]);}
return CTreeView.prototype.onDblClick.apply(this,arguments);};proto.selectNode=function(tnode,event){ecma.dom.removeClassName(this.ui.rm,'disabled');ecma.dom.removeClassName(this.ui.upload,'disabled');ecma.dom.removeClassName(this.ui.mkdir,'disabled');CTreeView.prototype.selectNode.apply(this,[tnode]);};proto.deselectNode=function(tnode){ecma.dom.addClassName(this.ui.rm,'disabled');ecma.dom.addClassName(this.ui.upload,'disabled');ecma.dom.addClassName(this.ui.mkdir,'disabled');CTreeView.prototype.deselectNode.apply(this,arguments);};proto.attach=function(pElem,w,h){this.createUI(w,h);pElem=ecma.dom.getElement(pElem);ecma.dom.replaceChildren(pElem,[this.getElement()]);return this;};proto.show=function(pElem){var box=this.getElement();ecma.dom.setStyle(box,'visibility','visible');return this;};proto.getSelectedDirectory=function(){var tnode=this.getSelection()[0];if(!tnode)return;var dnode=tnode.data;while(dnode&&!dnode.isDirectory()){dnode=dnode.parentNode;}
return dnode;};proto.onUpload=function(event){ecma.dom.stopEvent(event);var dnode=this.getSelectedDirectory();if(!dnode)return;if(!this.uplDlg||this.uplDlg.isLoading){this.uplDlg=new ecma.hubb.ui.UploadDialog();}
this.uplDlg.show(dnode);};proto.onMkdir=function(event){ecma.dom.stopEvent(event);var dnode=this.getSelectedDirectory();if(!dnode)return;if(!this.mkdirDlg){this.mkdirDlg=new ecma.hubb.ui.NewDirectoryDialog();}
this.mkdirDlg.show(dnode);};proto.onDelete=function(event){ecma.dom.stopEvent(event);var tnode=this.getSelection()[0];if(!tnode)return;var addr=tnode.getAddress();if(confirm('Are you sure you want to delete: '+addr)){ecma.hubb.getInstance().remove(addr);}};proto.onToggle=function(event){ecma.dom.stopEvent(event);if(this.isVisible){this.hide();}else{this.show();}};proto.getElement=function(){return this.ui.box;};proto.createUI=function(w,h){try{this.expand(this.rootAddr,[function(){this.select(this.rootAddr);},this]);}catch(ex){}
this.ui.listElem=ecma.dom.createElement('div',{'style':{'overflow':'auto','height':h?h+'px':'auto'}},[this.ui.outer]);this.ui.upload=ecma.dom.createElement('a',{'onClick':[this.onUpload,this],'innerHTML':'Upload','class':'disabled','style':{'cursor':'pointer'}});this.ui.mkdir=ecma.dom.createElement('a',{'onClick':[this.onMkdir,this],'innerHTML':'New Folder','class':'disabled','style':{'cursor':'pointer'}});this.ui.rm=ecma.dom.createElement('a',{'onClick':[this.onDelete,this],'innerHTML':'Delete','class':'disabled','style':{'cursor':'pointer'}});this.ui.box=ecma.dom.createElement('div',{'style':{'visibility':'hidden','width':w?w+'px':'auto'}},['div',{'style':{'border-top':'1px solid gray','border-left':'1px solid gray','border-right':'1px solid gray','border-bottom':'1px solid gray','background-color':'#fefefe'}},[this.ui.listElem,'div',{'style':{'padding':'2px','font-size':'.8em','border-top':'1px solid gray'}},['div',{'align':'right'},[this.ui.upload,'#text',{'nodeValue':' | '},this.ui.mkdir,'#text',{'nodeValue':' | '},this.ui.rm]]]]);};});ECMAScript.Extend('hubb.ui',function(ecma){var CTreeView=ecma.hubb.ui.TreeView;var CComboBox=ecma.lsn.ComboBox;var proto=ecma.lang.createPrototype(CComboBox,CTreeView);this.ComboBox=function(){CComboBox.apply(this);CTreeView.apply(this);this.createUI();};this.ComboBox.prototype=proto;proto.canExpand=function(tnode){return tnode.data.isDirectory();};proto.onDblClick=function(event,tnode){if(!tnode.data.isDirectory()){this.hide();return CTreeView.prototype.selectNode.apply(this,[tnode,event]);}
return CTreeView.prototype.onDblClick.apply(this,arguments);};proto.selectNode=function(tnode,event){ecma.dom.removeClassName(this.ui.rm,'disabled');ecma.dom.removeClassName(this.ui.upload,'disabled');ecma.dom.removeClassName(this.ui.mkdir,'disabled');if(tnode.data.getAddress()!=this.ctrl.value){this.ctrl.value=tnode.data.getAddress();}
CTreeView.prototype.selectNode.apply(this,[tnode]);};proto.deselectNode=function(tnode){ecma.dom.addClassName(this.ui.rm,'disabled');ecma.dom.addClassName(this.ui.upload,'disabled');ecma.dom.addClassName(this.ui.mkdir,'disabled');CTreeView.prototype.deselectNode.apply(this,arguments);};proto.show=function(){CComboBox.prototype.show.apply(this,arguments);try{this.select(this.ctrl.value);}catch(ex){}};proto.getSelectedDirectory=function(){var tnode=this.getSelection()[0];if(!tnode)return;var dnode=tnode.data;while(dnode&&!dnode.isDirectory()){dnode=dnode.parentNode;}
return dnode;};proto.onUpload=function(event){ecma.dom.stopEvent(event);var dnode=this.getSelectedDirectory();if(!dnode)return;if(!this.uplDlg||this.uplDlg.isLoading){this.uplDlg=new ecma.hubb.ui.UploadDialog();}
this.uplDlg.show(dnode);};proto.onMkdir=function(event){ecma.dom.stopEvent(event);var dnode=this.getSelectedDirectory();if(!dnode)return;if(!this.mkdirDlg){this.mkdirDlg=new ecma.hubb.ui.NewDirectoryDialog();}
this.mkdirDlg.show(dnode);};proto.onDelete=function(event){ecma.dom.stopEvent(event);var tnode=this.getSelection()[0];if(!tnode)return;var addr=tnode.getAddress();if(confirm('Are you sure you want to delete: '+addr)){ecma.hubb.getInstance().remove(addr);}};proto.onToggle=function(event){ecma.dom.stopEvent(event);if(this.isVisible){this.hide();}else{this.show();}};proto.getElement=function(){return this.ui.box;};proto.createUI=function(){this.ui.listElem=ecma.dom.createElement('div',{'style':{'overflow':'auto','height':'200px'}},[this.ui.outer]);this.ui.upload=ecma.dom.createElement('a',{'onClick':[this.onUpload,this],'innerHTML':'Upload','class':'disabled','style':{'cursor':'pointer'}});this.ui.mkdir=ecma.dom.createElement('a',{'onClick':[this.onMkdir,this],'innerHTML':'New Folder','class':'disabled','style':{'cursor':'pointer'}});this.ui.rm=ecma.dom.createElement('a',{'onClick':[this.onDelete,this],'innerHTML':'Delete','class':'disabled','style':{'cursor':'pointer'}});this.ui.box=ecma.dom.createElement('div',{'style':{'position':'absolute','visibility':'hidden','left':'0'}},['div',{'style':{'border-left':'1px solid gray','border-right':'1px solid gray','border-bottom':'1px solid gray','background-color':'#fefefe'}},[this.ui.listElem,'div',{'style':{'padding':'2px','font-size':'.8em','border-top':'1px solid gray'}},['div',{'align':'right'},[this.ui.upload,'#text',{'nodeValue':' | '},this.ui.mkdir,'#text',{'nodeValue':' | '},this.ui.rm]]]]);};});ECMAScript.Extend('hubb.ui',function(ecma){var proto={};this.TargetDialog=function(rootAddr,dlgURL){this.ui={};this.rootAddr=rootAddr;this.dlg=new ecma.lsn.Dialog(dlgURL,{refetch:false});this.dlg.addEvent('load',[this.onLoad,this]);this.dlg.addEvent('show',[this.onShow,this]);this.dlg.addEvent('ok',[this.onOk,this]);this.dlg.addEvent('cancel',[this.onCancel,this]);};this.TargetDialog.prototype=proto;proto.show=function(dnode){if(!dnode)throw new Error('Missing source node');this.srcNode=dnode;this.dlg.show();};proto.hide=function(){this.dlg.hide();};proto.onSelect=function(action,tnode){this.destNode=tnode.data;this.updateUI();};proto.getName=function(){return ecma.dom.getValue(this.ui.name);};proto.getAddress=function(){if(!this.destNode)return'';var addr=this.destNode.getAddress();var name=this.getName();var addr=ecma.data.addr_normalize(addr+'/'+name);return addr;};proto.isNameValid=function(){var name=this.getName();if(!name)return false;if(new String(name).match(/[\/:?#;&]/))return false;return true;};proto.isTargetValid=function(){if(!this.isNameValid())return false;var addr=this.getAddress();if(!addr)return false;var srcAddr=this.srcNode.getAddress();if(addr==srcAddr||addr.indexOf(srcAddr+'/')==0)return false;if(ecma.hubb.getInstance().getNodeByAddress(addr))return false;return true;};proto.updateUI=function(){ecma.dom.setValue(this.ui.toaddr,this.getAddress());if(this.isNameValid()){ecma.dom.removeClassName(this.ui.name,'invalid');}else{ecma.dom.addClassName(this.ui.name,'invalid');}
if(this.isTargetValid()){ecma.dom.removeAttribute(this.ui.btnOk,'disabled');ecma.dom.removeClassName(this.ui.toaddr,'invalid');}else{ecma.dom.setAttribute(this.ui.btnOk,'disabled','disabled');ecma.dom.addClassName(this.ui.toaddr,'invalid');}};proto.onLoad=function(){this.ui.tview=this.dlg.getElementById('tview');this.ui.name=this.dlg.getElementById('name');this.ui.toaddr=this.dlg.getElementById('toaddr');this.ui.btnOk=this.dlg.getElementById('btn_ok');this.ui.btnCancel=this.dlg.getElementById('btn_cancel');this.actNameChange=new ecma.lsn.InputListener(this.ui.name);this.actNameChange.addActionListener('change',this.updateUI,this);};proto.onNameChange=function(event){this.updateUI();};proto.onShow=function(){var paddr=ecma.data.addr_parent(this.srcNode.getAddress());var name=ecma.data.addr_name(this.srcNode.getAddress());ecma.dom.setValue(this.ui.name,name);if(this.srcNode.isData()){this.attachDataList(paddr);}else{this.attachFolderList(paddr);}
this.ui.name.focus();};proto.onOk=function(){};proto.onCancel=function(){};proto.attachFolderList=function(addr){if(!this.folderList){this.folderList=new ecma.hubb.ui.FolderList(this.rootAddr);this.folderList.addActionListener('select',this.onSelect,this);}
ecma.dom.replaceChildren(this.ui.tview,[this.folderList.getElement()]);this.folderList.select(addr);};proto.attachDataList=function(addr){if(!this.dataList){this.dataList=new ecma.hubb.ui.DataList(this.rootAddr);this.dataList.addActionListener('select',this.onSelect,this);}
ecma.dom.replaceChildren(this.ui.tview,[this.dataList.getElement()]);this.dataList.select(addr);};});ECMAScript.Extend('hubb.ui',function(ecma){var CTargetDialog=ecma.hubb.ui.TargetDialog;var proto=ecma.lang.createPrototype(CTargetDialog);this.CopyDialog=function(){CTargetDialog.apply(this,['/','/res/hub/dlg/copy.html']);};this.CopyDialog.prototype=proto;proto.onOk=function(){if(this.isTargetValid()){var srcAddr=this.srcNode.getAddress();var destAddr=this.getAddress();ecma.hubb.getInstance().copy(srcAddr,destAddr);}};});ECMAScript.Extend('hubb.ui',function(ecma){var CTargetDialog=ecma.hubb.ui.TargetDialog;var proto=ecma.lang.createPrototype(CTargetDialog);this.MoveDialog=function(){CTargetDialog.apply(this,['/','/res/hub/dlg/move.html']);};this.MoveDialog.prototype=proto;proto.onOk=function(){if(this.isTargetValid()){var srcAddr=this.srcNode.getAddress();var destAddr=this.getAddress();ecma.hubb.getInstance().move(srcAddr,destAddr);}};});ECMAScript.Extend('hubb.ui',function(ecma){var CTreeView=ecma.hubb.ui.TreeView;this.FolderList=function(){CTreeView.apply(this,arguments);};var proto=this.FolderList.prototype=ecma.lang.createPrototype(CTreeView);proto.canDisplay=function(dnode){return dnode.isDirectory();};});ECMAScript.Extend('hubb.ui',function(ecma){var CTreeView=ecma.hubb.ui.TreeView;this.DataList=function(){CTreeView.apply(this,arguments);};var proto=this.DataList.prototype=ecma.lang.createPrototype(CTreeView);proto.canDisplay=function(dnode){return dnode.isDirectory()||dnode.isDataContainer();};proto.onClick=function(event,tnode){if(tnode.data.isDataContainer()){CTreeView.prototype.onClick.apply(this,arguments);}else{ecma.dom.stopEvent(event);}};});ECMAScript.Extend('hubb.ui',function(ecma){var proto={};this.CreateDialog=function(rootAddr,dlgURL,dlgOpts){this.ui={};this.rootAddr=rootAddr;var opts={refetch:false};if(dlgOpts)ecma.util.overlay(opts,dlgOpts);this.dlg=new ecma.lsn.Dialog(dlgURL,opts);this.dlg.addEvent('load',[this.onLoad,this]);this.dlg.addEvent('show',[this.onShow,this]);this.dlg.addEvent('ok',[this.onOk,this]);this.dlg.addEvent('cancel',[this.onCancel,this]);};this.CreateDialog.prototype=proto;proto.show=function(dnode){if(!dnode)throw new Error('Missing source node');if(!dnode.hasFetched())dnode.fetch();this.srcNode=dnode;this.dlg.show();};proto.hide=function(){this.dlg.hide();};proto.getName=function(){return ecma.dom.getValue(this.ui.name);};proto.setName=function(name){return ecma.dom.setValue(this.ui.name,name);};proto.getAddress=function(){var addr=this.srcNode.getAddress();var name=this.getName();var addr=ecma.data.addr_normalize(addr+'/'+name);return addr;};proto.isNameValid=function(){var name=this.getName();if(!name)return false;if(new String(name).match(/[\/:?#;&]/))return false;return true;};proto.isTargetValid=function(){if(!this.isNameValid())return false;var addr=this.getAddress();if(!ecma.dom.getValue(this.ui.replace)){if(ecma.hubb.getInstance().getNodeByAddress(addr))return false;}
return true;};proto.updateUI=function(){ecma.dom.setValue(this.ui.toaddr,this.getAddress());if(this.isNameValid()){ecma.dom.removeClassName(this.ui.name,'invalid');}else{ecma.dom.addClassName(this.ui.name,'invalid');}
if(this.isTargetValid()){ecma.dom.removeAttribute(this.ui.btnOk,'disabled');ecma.dom.removeClassName(this.ui.toaddr,'invalid');}else{ecma.dom.setAttribute(this.ui.btnOk,'disabled','disabled');ecma.dom.addClassName(this.ui.toaddr,'invalid');}};proto.onLoad=function(){this.ui.name=this.dlg.getElementById('name');this.ui.replace=this.dlg.getElementById('replace');this.ui.toaddr=this.dlg.getElementById('toaddr');this.ui.btnOk=this.dlg.getElementById('btn_ok');this.ui.btnCancel=this.dlg.getElementById('btn_cancel');this.ui.title=this.dlg.getElementById('dlgtitle');this.actNameChange=new ecma.lsn.InputListener(this.ui.name);this.actNameChange.addActionListener('change',this.updateUI,this);if(this.ui.replace){this.actReplace=new ecma.dom.EventListener(this.ui.replace,'change',this.updateUI,this);}};proto.onNameChange=function(event){this.updateUI();};proto.onShow=function(){this.setName('');ecma.dom.setValue(this.ui.title,this.getTitle());if(this.ui.replace)ecma.dom.setValue(this.ui.replace,false);this.ui.name.focus();this.updateUI();};proto.getTitle=function(){return'Create';};proto.onOk=function(){};proto.onCancel=function(){};});ECMAScript.Extend('hubb.ui',function(ecma){var CCreateDialog=ecma.hubb.ui.CreateDialog;var proto=ecma.lang.createPrototype(CCreateDialog);this.NewDirectoryDialog=function(){CCreateDialog.apply(this,['/','/res/hub/dlg/new.html']);};this.NewDirectoryDialog.prototype=proto;proto.onOk=function(){if(this.isTargetValid()){var addr=this.srcNode.getAddress();var name=this.getName();ecma.hubb.getInstance().create(addr,name,'directory');}};proto.getTitle=function(){return'Create a new folder';};});ECMAScript.Extend('hubb.ui',function(ecma){var CCreateDialog=ecma.hubb.ui.CreateDialog;var proto=ecma.lang.createPrototype(CCreateDialog);this.NewFileDialog=function(){CCreateDialog.apply(this,['/','/res/hub/dlg/new.html']);};this.NewFileDialog.prototype=proto;proto.onOk=function(){if(this.isTargetValid()){var addr=this.srcNode.getAddress();var name=this.getName();ecma.hubb.getInstance().create(addr,name,'file-text');}};proto.getTitle=function(){return'Create a new text file';};});ECMAScript.Extend('hubb.ui',function(ecma){var CCreateDialog=ecma.hubb.ui.CreateDialog;var proto=ecma.lang.createPrototype(CCreateDialog);this.UploadDialog=function(){var opts={sticky:true};CCreateDialog.apply(this,['/','/res/hub/dlg/upload.html',opts]);};this.UploadDialog.prototype=proto;proto.getTitle=function(){return'Upload a file';};proto.show=function(){if(this.isLoading)return;CCreateDialog.prototype.show.apply(this,arguments);};proto.onShow=function(){this.ui.uplframe=ecma.dom.createElement('iframe',{'frameborder':0,'class':'uplframe'});this.evtLoad=new ecma.dom.EventListener(this.ui.uplframe,'load',this.onIframeLoad,this);ecma.dom.setAttribute(this.ui.uplframe,'src','/res/hub/dlg/upload-form.html');this.ui.uplarea=this.dlg.getElementById('uplarea')
ecma.dom.replaceChildren(this.ui.uplarea,[this.ui.uplframe]);CCreateDialog.prototype.onShow.apply(this);};proto.onIframeLoad=function(){var doc=ecma.dom.getContentDocument(this.ui.uplframe);var win=ecma.dom.getContentWindow(this.ui.uplframe);this.docjs=new ECMAScript.Class(win,doc);this.ui.uplform=this.docjs.dom.getElement('form');this.ui.uplctrl=this.docjs.dom.getElement('file');this.docjs.dom.addEventListener(this.ui.uplctrl,'change',this.onChoose,this);this.ui.name.blur();this.evtLoad.remove();};proto.onChoose=function(){var fn=this.getFilename();this.setName(fn);this.ui.name.focus();CCreateDialog.prototype.updateUI.apply(this,arguments);};proto.isTargetValid=function(){if(!this.getFilename())return false;return CCreateDialog.prototype.isTargetValid.apply(this);};proto.getFilename=function(){if(!this.ui.uplctrl)return'';var value=this.ui.uplctrl.value;var fn=value.replace(/\\/g,'/');var idx=fn.lastIndexOf('/');idx=ecma.util.defined(idx)?idx+1:0;fn=fn.substr(idx);return fn;};proto.onOk=function(){if(this.isTargetValid()){var addr=this.srcNode.getAddress();var name=this.getName();var replace=ecma.dom.getValue(this.ui.replace)?1:0;var id=ecma.util.randomId();this.ui.uplform.action='/api/hub/upload?'
+'X-Progress-ID='+id
+'&X-Auth-Token='+ecma.lsn.auth.getAuthToken()
+'&target='+encodeURIComponent(addr)
+'&name='+name
+'&replace='+replace;this.ui.uplform.submit();this.isLoading=true;ecma.hubb.getInstance().progress(addr,name,id,'upload',[this.onComplete,this]);}};proto.onComplete=function(dnode){this.isLoading=false;};});ECMAScript.Extend('hubb.ui',function(ecma){var CCreateDialog=ecma.hubb.ui.CreateDialog;var proto=ecma.lang.createPrototype(CCreateDialog);this.DownloadDialog=function(){CCreateDialog.apply(this,['/','/res/hub/dlg/download.html']);};this.DownloadDialog.prototype=proto;proto.getTitle=function(){return'Fetch a file from the internet';};proto.onLoad=function(){CCreateDialog.prototype.onLoad.apply(this,arguments);this.ui.uri=this.dlg.getElementById('uri');ecma.dom.addEventListener(this.ui.uri,'change',this.onChange,this);};proto.onShow=function(){ecma.dom.setValue(this.ui.uri,'');CCreateDialog.prototype.onShow.apply(this);this.ui.uri.focus();};proto.onChange=function(){var fn=this.getFilename();this.setName(fn);CCreateDialog.prototype.updateUI.apply(this,arguments);};proto.isTargetValid=function(){if(!this.getFilename())return false;return CCreateDialog.prototype.isTargetValid.apply(this);};proto.getFilename=function(){var value=this.getUri();var fn=value.replace(/\\/g,'/');var idx=fn.lastIndexOf('/');idx=ecma.util.defined(idx)?idx+1:0;fn=fn.substr(idx);fn=ecma.window.decodeURIComponent(fn);return fn;};proto.getUri=function(){return ecma.dom.getValue(this.ui.uri);};proto.onOk=function(){if(this.isTargetValid()){var addr=this.srcNode.getAddress();var name=this.getName();var uri=this.getUri();ecma.hubb.getInstance().download(addr,name,uri,[this.onComplete,this]);}};proto.onComplete=function(dnode){};});ECMAScript.Extend('hubb.ui',function(ecma){var _dlgUri='/res/hub/dlg/browse.html';var proto={};this.BrowseDialog=function(rootAddr,dlgUri){this.ui={};this.rootAddr=rootAddr||'/';this.dlg=new ecma.lsn.Dialog(dlgUri||_dlgUri,{refetch:false});this.dlg.addEvent('load',[this.onLoad,this]);this.dlg.addEvent('show',[this.onShow,this]);this.dlg.addEvent('ok',[this.onOk,this]);this.dlg.addEvent('cancel',[this.onCancel,this]);this.destNode=null;};this.BrowseDialog.prototype=proto;proto.show=function(addr){this.srcAddr=addr||this.rootAddr;this.dlg.show();};proto.hide=function(){if(this.tview){this.tview.destroyListeners();}
this.dlg.hide();};proto.onSelect=function(action,tnode){this.destNode=tnode.data;this.updateUI();};proto.onDeselect=function(action,tnode){this.destNode=null;this.updateUI();};proto.getTarget=function(){return this.destNode;};proto.isTargetValid=function(){return this.destNode?true:false;};proto.updateUI=function(){if(this.isTargetValid()){ecma.dom.removeAttribute(this.ui.btnOk,'disabled');}else{ecma.dom.setAttribute(this.ui.btnOk,'disabled','disabled');}};proto.onLoad=function(){this.ui.tview=this.dlg.getElementById('tview');this.ui.btnOk=this.dlg.getElementById('btn_ok');this.ui.btnCancel=this.dlg.getElementById('btn_cancel');};proto.onShow=function(){this.attachView();this.tview.select(this.srcAddr);};proto.onOk=function(){};proto.onCancel=function(){};proto.attachView=function(){if(this.tview){this.tview.initListeners();}else{this.tview=new ecma.hubb.ui.TreeView(this.rootAddr);this.tview.addActionListener('select',this.onSelect,this);this.tview.addActionListener('deselect',this.onDeselect,this);ecma.dom.replaceChildren(this.ui.tview,[this.tview.getElement()]);}};});ECMAScript.Extend('hubb.ui.input',function(ecma){this.Control=function(node,input){this.node=node;this.input=input;this.elems=[input.elem];this.statusIcon=new ecma.hubb.ui.input.StatusIcon();this.appendElements(this.statusIcon.getElements());this.input.deserialize(node.getValue());this.input.addActionListener('onChange',this.save,this);};var _proto=this.Control.prototype={};_proto.getElements=function(){return this.elems;};_proto.appendElements=function(elems){this.elems=this.elems.concat(elems);};_proto.save=function(){this.node.setValue(this.input.serialize());ecma.dom.setAttribute(this.input.elem,'disabled','disabled');this.statusIcon.showActive();ecma.hubb.getInstance().store(this.node.getAddress(),this.node.getValue(),[this.onSaveComplete,this]);};_proto.onSaveComplete=function(){ecma.dom.removeAttribute(this.input.elem,'disabled');this.statusIcon.showComplete();};_proto.setWidth=function(width){js.dom.setStyle(this.input.elem,'width',width);};});ECMAScript.Extend('hubb.ui.input',function(ecma){var CInput=ecma.lsn.forms.InputBoolean;var CControl=ecma.hubb.ui.input.Control;var _css=null;function _initStyles(){if(_css)return;_css=new ecma.dom.StyleSheet();_css.createRule('select.true',{'color':'green','font-weight':'bold'});_css.createRule('select.false',{'color':'black'});_css.createRule('select option',{'color':'black','font-weight':'normal'});};this.InputBoolean=function(node){_initStyles();var input=new CInput(ecma.dom.createElement('select',['option',{'value':0,'innerHTML':'False'},'option',{'value':1,'innerHTML':'True'},]));CControl.apply(this,[node,input])
new ecma.dom.EventListener(input.elem,'onChange',this.updateUI,this);this.updateUI();};var _proto=this.InputBoolean.prototype=ecma.lang.createPrototype(CControl);_proto.updateUI=function(){var className=this.input.getValue().valueOf()?'true':'false';ecma.dom.setClassName(this.input.elem,className);};});ECMAScript.Extend('hubb.ui.input',function(ecma){var CInput=ecma.lsn.forms.InputTextarea;var CControl=ecma.hubb.ui.input.Control;var _css={'margin-bottom':'0','border-width':'1px','border-style':'solid','border-color':'black','padding-left':'2px'};this.InputTextarea=function(node){var input=new CInput(ecma.dom.createElement('textarea',{'style':_css}));CControl.apply(this,[node,input])
this.rszta=new ecma.hubb.ui.input.ResizeTextarea(this.input.elem);this.appendElements(this.rszta.getElements());};var _proto=this.InputTextarea.prototype=ecma.lang.createPrototype(CControl);_proto.setWidth=function(width){CControl.prototype.setWidth.apply(this,arguments);js.dom.setStyle(this.rszta.elem,'width',width);};});ECMAScript.Extend('hubb.ui.input',function(ecma){var CInput=ecma.lsn.forms.InputText;var CControl=ecma.hubb.ui.input.Control;var _css={'margin-bottom':'0','border-width':'1px','border-style':'solid','border-color':'black','padding':'2px'};this.InputText=function(node){var input=new CInput(ecma.dom.createElement('input',{'style':_css}));CControl.apply(this,[node,input])};var _proto=this.InputText.prototype=ecma.lang.createPrototype(CControl);});ECMAScript.Extend('hubb.ui.input',function(ecma){var _proto={};var _css={'margin-top':'0','padding':'0 1px','height':'3px','font-size':'0','line-height':'0','cursor':'n-resize','border-width':'0 1px 1px 1px','border-style':'solid','border-color':'black','background-color':'gray'};this.ResizeTextarea=function(textarea){this.textarea=ecma.dom.getElement(textarea);this.mask=new ecma.lsn.Mask({opacity:0,cursor:'s-resize'});this.dims={h:undefined};this.elem=ecma.dom.createElement('div.rszta',{'style':_css});this.handle=new ecma.lsn.DragHandle(this.elem,{'onMouseMove':[this.onMouseMove,this],'onMouseDown':[this.onMouseDown,this],'onMouseUp':[this.onMouseUp,this]});this.ui=[this.elem]};this.ResizeTextarea.prototype=_proto;_proto.getElements=function(){return this.ui;};_proto.onMouseMove=function(event,dh){ecma.dom.stopEvent(event);var h=Math.max(this.dims.h+dh.delta_y,30);ecma.dom.setStyle(this.textarea,'height',h+'px');};_proto.onMouseDown=function(event,dh){ecma.dom.stopEvent(event);this.dims.h=ecma.dom.getHeight(this.textarea);this.mask.show();};_proto.onMouseUp=function(event,dh){ecma.dom.stopEvent(event);this.mask.hide();};});ECMAScript.Extend('hubb.ui.input',function(ecma){var _imgReady='/res/icons/16x16/status/blank.gif';var _imgActive='/res/icons/16x16/status/saving.gif';var _imgComplete='/res/icons/16x16/status/checkmark.gif';var _css={'margin':'0 2px','vertical-align':'middle','border':'none'};this.StatusIcon=function(node){this.elem=ecma.dom.createElement('img',{'src':_imgReady,'width':16,'height':16,'border':0,'style':_css});this.ui=[this.elem];this.fade=new ecma.fx.effects.Opacify(this.elem,1,.25,1000);};var _proto=this.StatusIcon.prototype=ecma.lang.createPrototype();_proto.getElements=function(){return this.ui;};_proto.showActive=function(){ecma.dom.setOpacity(this.elem,1);ecma.dom.setAttribute(this.elem,'src',_imgActive);};_proto.showComplete=function(){ecma.dom.setOpacity(this.elem,1);ecma.dom.setAttribute(this.elem,'src',_imgComplete);ecma.dom.setTimeout(this.fade.start,1000,this.fade);};_proto.showReady=function(){ecma.dom.setOpacity(this.elem,1);ecma.dom.setAttribute(this.elem,'src',_imgReady);};});